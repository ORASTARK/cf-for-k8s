#@ load("@ytt:data", "data")
#@ load("@ytt:json", "json")
#@ load("@ytt:yaml", "yaml")
#@ load("@ytt:overlay", "overlay")

---
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  name: envoy
  namespace: projectcontour
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: contour-certgen
subjects:
- kind: ServiceAccount
  name: envoy
  namespace: projectcontour

#@overlay/match by=overlay.subset({"kind": "DaemonSet", "metadata": {"name": "envoy"}})
---
spec:
  template:
    metadata:
      #@overlay/match missing_ok=True
      annotations:
        #@overlay/match missing_ok=True
        sidecar.istio.io/inject: "false"
    spec:
      automountServiceAccountToken: true
      #@overlay/match missing_ok=True
      initContainers:
      #@overlay/append
      - name: istio-proxy
        image: gcr.io/cf-routing/proxyv2:1.7.1
        imagePullPolicy: Always
        ports:
        - containerPort: 15090
          protocol: TCP
          name: http-envoy-prom
        command:
          - bash
        args:
        - -xc
        - |
          check_certs() {
            while true; do
              if [[ -s "/etc/istio-certs/root-cert.pem" && -s "/etc/istio-certs/cert-chain.pem" && -s "/etc/istio-certs/key.pem" ]]; then
                echo "Secrets are in-place"
                curl -XPOST http://localhost:15000/quitquitquit
                break
              else
                sleep 1
              fi
            done
          }

          check_certs &
          /usr/local/bin/pilot-agent proxy sidecar --domain $(POD_NAMESPACE).svc.cluster.local istio-proxy-prometheus --proxyLogLevel=warning --proxyComponentLogLevel=misc:error --controlPlaneAuthPolicy NONE --trust-domain=cluster.local
        env:
        - name: OUTPUT_CERTS
          value: /etc/istio-certs
        - name: JWT_POLICY
          value: third-party-jwt
        - name: PILOT_CERT_PROVIDER
          value: istiod
        - name: CA_ADDR
          value: istiod.istio-system.svc:15012
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: INSTANCE_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: SERVICE_ACCOUNT
          valueFrom:
            fieldRef:
              fieldPath: spec.serviceAccountName
        - name: HOST_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        - name: ISTIO_META_MESH_ID
          value: cluster.local
        - name: ISTIO_META_CLUSTER_ID
          value: Kubernetes
        volumeMounts:
        - mountPath: /var/run/secrets/istio
          name: istiod-ca-cert
        - mountPath: /etc/istio/proxy
          name: istio-envoy
        - mountPath: /var/run/secrets/tokens
          name: istio-token
        - mountPath: /etc/istio-certs/
          name: istio-certs
        - mountPath: /etc/istio/config
          name: istio-config-volume

      #@overlay/append
      - name: save-certs
        image: gcr.io/cf-networking-images/cf-k8s-networking/save-istio-secrets:latest
        imagePullPolicy: Always
        args:
        - projectcontour
        volumeMounts:
        - mountPath: /etc/istio-certs
          name: istio-certs
        env:
        - name: DEBUG
          value: "yes,please"
      volumes:
      #@overlay/append
      - name: istio-config-volume
        configMap:
          name: istio
          optional: true
      #@overlay/append
      - name: istio-certs
        emptyDir:
            medium: Memory
      #@overlay/append
      - name: istio-envoy
        emptyDir:
          medium: Memory
      #@overlay/append
      - name: istio-token
        projected:
          defaultMode: 420
          sources:
          - serviceAccountToken:
              audience: istio-ca
              expirationSeconds: 43200
              path: istio-token
      #@overlay/append
      - name: istiod-ca-cert
        configMap:
            defaultMode: 419
            name: istio-ca-root-cert

